---
title: "WiFiルーターの構築"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["raspberrypi"]
published: false
---
ラズパイ5でWiFiを構築方法に関する記事です。

## 事前準備
RaspberryPi OSをインストール済みのラズパイ5(4以下の動作は保証しません)を用意してください。

なお、今回WiFiルーターを作る関係で、無線通信はできないため、あらかじめ有線接続してください。

## 必要なパッケージのインストール
- unbound - [DNS](https://www.nic.ad.jp/ja/newsletter/No22/080.html)キャッシュサーバを動かします。
- hostapd - ラズパイ5に内蔵されているWiFiモジュールをアクセスポイントとして運用するのに必要です。
- iptables-persistent - iptablesの設定を永続化するのに必須です。

以下のコマンドでパッケージが入ります。
```
apt-get install -y unbound hostapd iptables-persistent
```

次に[DHCP](https://www.nic.ad.jp/ja/basics/terms/dhcp.html)サーバをインストールします。
```
curl -1sLf \
  'https://dl.cloudsmith.io/public/isc/kea-3-0/setup.deb.sh' \
  | sudo -E bash
apt-get install -y isc-kea-dhcp4
```

いまままでは`isc-dhcp4-server`をインストールして使っていたのですが、メンテナンスが終了していたようでして、後継の`isc-kea-dhcp4`をつかわないといけなくなりました。

## ネットワーク設定
`NetworkManager`をまず駆除しましょう。以下のコマンドでできます。(NetworkManagerはちょっと扱いずらい)
```
sudo systemctl disable NetworkManager
sudo systemctl stop NetworkManager
```

今回我々は`systemd-networkd`をつかって構築するので、`systemd-networkd`を有効にしましょう
```
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd
```

次にルーターのIPを設定するために、以下のファイルを`/etc/systemd/network/10-wlan0.conf`に貼ってください。
```conf:10-wlan0.conf
[Match]
Name=wlan0

[Network]
Address=172.16.45.254/24
```

さらにインターネット側のインターフェイスを設定しましょう。以下のファイルを`/etc/systemd/network/11-eth0.conf`に張ってください。
```conf:11-eth0.conf
[Match]
Name=eth0

[Network]
DHCP=yes
```

その後、設定を反映させてください。以下のコマンドでできます。
```
sudo systemctl restart systemd-networkd
```

## DHCPサーバの設定
DHCPサーバを構築するために、以下のファイルの内容を`/etc/kea/kea-dhcp4.conf`に張ってください。
```json:kea-dhcp4.conf
{
"Dhcp4": {
    "interfaces-config": {
        "interfaces": ["wlan0"]
    },

    "control-socket": {
        "socket-type": "unix",
        "socket-name": "kea4-ctrl-socket"
    },

    "lease-database": {
        "type": "memfile",
        "lfc-interval": 3600
    },

    "expired-leases-processing": {
        "reclaim-timer-wait-time": 10,
        "flush-reclaimed-timer-wait-time": 25,
        "hold-reclaimed-time": 3600,
        "max-reclaim-leases": 100,
        "max-reclaim-time": 250,
        "unwarned-reclaim-cycles": 5
    },

    "renew-timer": 900,
    "rebind-timer": 1800,
    "valid-lifetime": 3600,

    "option-data": [
        {
            "name": "domain-name-servers",
            "data": "172.16.45.254, 1.1.1.1"
        },
        {
            "name": "default-ip-ttl",
            "data": "0xf0"
        }
    ],

    "subnet4": [
        {
            "id": 1,
            "subnet": "172.16.45.0/24",
            "pools": [ { "pool": "172.16.45.1 - 172.16.45.200" } ],
            "interface": "wlan0",
            "option-data": [
                {
                    "name": "routers",
                    "data": "172.16.45.254"
                }
            ]
        }
    ],

    "loggers": [
    {
        "name": "kea-dhcp4",
        "output-options": [
            {
                "output": "stdout",
                "pattern": "%-5p %m\n"
            }
        ],
        "severity": "INFO",
        "debuglevel": 0
    }
  ]
}
}
```

次にDHCPサーバを動かしてください。以下のコマンドでできます。
```sh
sudo systemctl start isc-kea-dhcp4-server
sudo systemctl enable isc-kea-dhcp4-server
```

## hostapdの設定
ラズパイをアクセスポイント化するために、以下のファイルの内容を`/etc/hostapd/hostapd.conf`に張り付けてください。
```conf:hostapd.conf
ssid=Inchiki-Global-WiFi # SSIDを適宜変更してください。
wpa_passphrase=IPA-Daisuki # WiFiのパスワードです。必ず変更してください。
interface=wlan0
bridge=br0
auth_algs=1
channel=36
driver=nl80211
hw_mode=a
ieee80211n=1
ieee80211ac=1
logger_stdout=-1
logger_stdout_level=2
max_num_sta=5
rsn_pairwise=CCMP
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
```

ラズパイはもともとアクセスポイントとして運用する想定ではないので、以下のコマンドを実行してください。
```
# hostapdをマスクされているので解除してあげないと...
sudo systemctl unmask hostapd
sudo systemctl enable hostapd
sudo systemctl start hostapd
```

## unboundの設定
DNSキャッシュサーバを構築するために、以下のファイルを`/etc/unbound/unbound.conf.d/server.conf`に張りつけてください。
```conf:server.conf
server:
    interface: 0.0.0.0
    access-control: 172.16.45.0/24 allow
    
    logfile: "/var/log/unbound.log"
    use-syslog: no
    verbosity: 1

forward-zone:
    name: "."  
    forward-addr: 1.1.1.1 # Cloudflare Public DNS
```

unboundを再起動させて、設定を反映させます。以下のコマンドでできます。
```sh
sudo systemctl restart unbound
sudo systemctl enable unbound
```

## IPマスカレードをする
パケットに存在するIPヘッダーの送信元のIPアドレスをルーター側のIPアドレスに置換するようにIPマスカレードします。
以下のコマンドを実行してください。

```sh
sudo iptables -t nat -A POSTROUTING -s 172.16.45.0/24 -o eth0 -j MASQUERADE
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 以下のコマンドで永続化させる。
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

## IPフォワードできないので、設定する。
以下のファイルを`/etc/sysctl.d/99-forward.conf`に張ってください。
```conf:99-forward.conf
net.ipv4.ip_forward=1
```

## 最後に
WiFiルーター自作に関する話です。あんまり