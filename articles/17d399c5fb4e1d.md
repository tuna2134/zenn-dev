---
title: "WiFiãƒ«ãƒ¼ã‚¿ãƒ¼ã®æ§‹ç¯‰"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["raspberrypi"]
published: false
---
ãƒ©ã‚ºãƒ‘ã‚¤5ã§WiFiã‚’æ§‹ç¯‰æ–¹æ³•ã«é–¢ã™ã‚‹è¨˜äº‹ã§ã™ã€‚

## äº‹å‰æº–å‚™
RaspberryPi OSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ãƒ©ã‚ºãƒ‘ã‚¤5(4ä»¥ä¸‹ã®å‹•ä½œã¯ä¿è¨¼ã—ã¾ã›ã‚“)ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚

ãªãŠã€ä»Šå›WiFiãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½œã‚‹é–¢ä¿‚ã§ã€ç„¡ç·šé€šä¿¡ã¯ã§ããªã„ãŸã‚ã€ã‚ã‚‰ã‹ã˜ã‚æœ‰ç·šæ¥ç¶šã—ã¦ãã ã•ã„ã€‚

## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- unbound - [DNS](https://www.nic.ad.jp/ja/newsletter/No22/080.html)ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒã‚’å‹•ã‹ã—ã¾ã™ã€‚
- hostapd - ãƒ©ã‚ºãƒ‘ã‚¤5ã«å†…è”µã•ã‚Œã¦ã„ã‚‹WiFiãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦é‹ç”¨ã™ã‚‹ã®ã«å¿…è¦ã§ã™ã€‚
- iptables-persistent - iptablesã®è¨­å®šã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã®ã«å¿…é ˆã§ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¥ã‚Šã¾ã™ã€‚
```
apt-get install -y unbound hostapd iptables-persistent
```

æ¬¡ã«[DHCP](https://www.nic.ad.jp/ja/basics/terms/dhcp.html)ã‚µãƒ¼ãƒã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
curl -1sLf \
  'https://dl.cloudsmith.io/public/isc/kea-3-0/setup.deb.sh' \
  | sudo -E bash
apt-get install -y isc-kea-dhcp4
```

ã„ã¾ã¾ã¾ã§ã¯`isc-dhcp4-server`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ä½¿ã£ã¦ã„ãŸã®ã§ã™ãŒã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒçµ‚äº†ã—ã¦ã„ãŸã‚ˆã†ã§ã—ã¦ã€å¾Œç¶™ã®`isc-kea-dhcp4`ã‚’ã¤ã‹ã‚ãªã„ã¨ã„ã‘ãªããªã‚Šã¾ã—ãŸã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
`NetworkManager`ã‚’ã¾ãšé§†é™¤ã—ã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚(NetworkManagerã¯ã¡ã‚‡ã£ã¨æ‰±ã„ãšã‚‰ã„)
```
sudo systemctl disable NetworkManager
sudo systemctl stop NetworkManager
```

ä»Šå›æˆ‘ã€…ã¯`systemd-networkd`ã‚’ã¤ã‹ã£ã¦æ§‹ç¯‰ã™ã‚‹ã®ã§ã€`systemd-networkd`ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ã‚‡ã†
```
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd
```

æ¬¡ã«ãƒ«ãƒ¼ã‚¿ãƒ¼ã®IPã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`/etc/systemd/network/10-wlan0.conf`ã«è²¼ã£ã¦ãã ã•ã„ã€‚
```conf:10-wlan0.conf
[Match]
Name=wlan0

[Network]
Address=172.16.45.254/24
```

ã•ã‚‰ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå´ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`/etc/systemd/network/11-eth0.conf`ã«å¼µã£ã¦ãã ã•ã„ã€‚
```conf:11-eth0.conf
[Match]
Name=eth0

[Network]
DHCP=yes
```

ãã®å¾Œã€è¨­å®šã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚
```
sudo systemctl restart systemd-networkd
```

## DHCPã‚µãƒ¼ãƒã®è¨­å®š
DHCPã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’`/etc/kea/kea-dhcp4.conf`ã«å¼µã£ã¦ãã ã•ã„ã€‚
```json:kea-dhcp4.conf
{
"Dhcp4": {
    "interfaces-config": {
        "interfaces": ["wlan0"]
    },

    "control-socket": {
        "socket-type": "unix",
        "socket-name": "kea4-ctrl-socket"
    },

    "lease-database": {
        "type": "memfile",
        "lfc-interval": 3600
    },

    "expired-leases-processing": {
        "reclaim-timer-wait-time": 10,
        "flush-reclaimed-timer-wait-time": 25,
        "hold-reclaimed-time": 3600,
        "max-reclaim-leases": 100,
        "max-reclaim-time": 250,
        "unwarned-reclaim-cycles": 5
    },

    "renew-timer": 900,
    "rebind-timer": 1800,
    "valid-lifetime": 3600,

    "option-data": [
        {
            "name": "domain-name-servers",
            "data": "172.16.45.254, 1.1.1.1"
        },
        {
            "name": "default-ip-ttl",
            "data": "0xf0"
        }
    ],

    "subnet4": [
        {
            "id": 1,
            "subnet": "172.16.45.0/24",
            "pools": [ { "pool": "172.16.45.1 - 172.16.45.200" } ],
            "interface": "wlan0",
            "option-data": [
                {
                    "name": "routers",
                    "data": "172.16.45.254"
                }
            ]
        }
    ],

    "loggers": [
    {
        "name": "kea-dhcp4",
        "output-options": [
            {
                "output": "stdout",
                "pattern": "%-5p %m\n"
            }
        ],
        "severity": "INFO",
        "debuglevel": 0
    }
  ]
}
}
```

æ¬¡ã«DHCPã‚µãƒ¼ãƒã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚
```sh
sudo systemctl start isc-kea-dhcp4-server
sudo systemctl enable isc-kea-dhcp4-server
```

## hostapdã®è¨­å®š
ãƒ©ã‚ºãƒ‘ã‚¤ã‚’ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆåŒ–ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’`/etc/hostapd/hostapd.conf`ã«å¼µã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
```conf:hostapd.conf
ssid=Inchiki-Global-WiFi # SSIDã‚’é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
wpa_passphrase=IPA-Daisuki # WiFiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
interface=wlan0
bridge=br0
auth_algs=1
channel=36
driver=nl80211
hw_mode=a
ieee80211n=1
ieee80211ac=1
logger_stdout=-1
logger_stdout_level=2
max_num_sta=5
rsn_pairwise=CCMP
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
```

ãƒ©ã‚ºãƒ‘ã‚¤ã¯ã‚‚ã¨ã‚‚ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦é‹ç”¨ã™ã‚‹æƒ³å®šã§ã¯ãªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```
# hostapdã‚’ãƒã‚¹ã‚¯ã•ã‚Œã¦ã„ã‚‹ã®ã§è§£é™¤ã—ã¦ã‚ã’ãªã„ã¨...
sudo systemctl unmask hostapd
sudo systemctl enable hostapd
sudo systemctl start hostapd
```

## unboundã®è¨­å®š
DNSã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`/etc/unbound/unbound.conf.d/server.conf`ã«å¼µã‚Šã¤ã‘ã¦ãã ã•ã„ã€‚
```conf:server.conf
server:
    interface: 0.0.0.0
    access-control: 172.16.45.0/24 allow
    
    logfile: "/var/log/unbound.log"
    use-syslog: no
    verbosity: 1

forward-zone:
    name: "."  
    forward-addr: 1.1.1.1 # Cloudflare Public DNS
```

unboundã‚’å†èµ·å‹•ã•ã›ã¦ã€è¨­å®šã‚’åæ˜ ã•ã›ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚
```sh
sudo systemctl restart unbound
sudo systemctl enable unbound
```

## IPãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ã‚’ã™ã‚‹
ãƒ‘ã‚±ãƒƒãƒˆã«å­˜åœ¨ã™ã‚‹IPãƒ˜ãƒƒãƒ€ãƒ¼ã®é€ä¿¡å…ƒã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ«ãƒ¼ã‚¿ãƒ¼å´ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®æ›ã™ã‚‹ã‚ˆã†ã«IPãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```sh
sudo iptables -t nat -A POSTROUTING -s 172.16.45.0/24 -o eth0 -j MASQUERADE
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ°¸ç¶šåŒ–ã•ã›ã‚‹ã€‚
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

## IPãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ããªã„ã®ã§ã€è¨­å®šã™ã‚‹ã€‚
ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`/etc/sysctl.d/99-forward.conf`ã«å¼µã£ã¦ãã ã•ã„ã€‚
```conf:99-forward.conf
net.ipv4.ip_forward=1
```

## æœ€å¾Œã«
WiFiãƒ«ãƒ¼ã‚¿ãƒ¼è‡ªä½œã«é–¢ã™ã‚‹è©±ã§ã™ã€‚ã‚ã‚“ã¾ã‚Š